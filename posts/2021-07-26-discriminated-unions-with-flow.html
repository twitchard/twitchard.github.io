<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@twitchard" />
        <meta name="twitter:title" content="Discriminated Unions and Exhaustiveness Checking" />
        <meta name="twitter:description" content="Use discriminated unions and exhaustiveness checking to level up your Javascript" />
        <meta name="description" property="og:description" content="Use discriminated unions and exhaustiveness checking to level up your Javascript" />
        <meta name="author" property="og:author" content="Richard Marmorstein" />
        
        <title>Discriminated Unions and Exhaustiveness Checking - Richard Marmorstein</title>
        <link rel="alternate" type="application/atom+xml" href="../atom.xml">
        <link rel="stylesheet" href="../css/default.css" />

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

        <link href="https://fonts.googleapis.com/css?family=Finger Paint" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
        <!-- Used for drop cap for the first character of blog posts-->
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> 
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet"> 
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DPC615L5M6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-DPC615L5M6');
    </script>
    </head>
    <body>
        <main role="main">
            <article>
    <section class="header">
      <h1>Discriminated Unions and Exhaustiveness Checking</h1>
      <h3>by Richard Marmorstein - July 26, 2021</h3>
      <h4><a href="../">← Home</a></h4>
    </section>
    <section class="prose">
        <p><img src="../images/dropCapF.png" alt="F" class="dropCap" />low and Typescript have a feature called “discriminated unions with exhaustiveness checking”. I use this feature extensively. The resulting code can look odd if you aren’t familiar with this style of programming, but I think any Typed Javascript developer really should learn about this to really take full advantage of the type system.</p>
<p>Discriminated unions aren’t that well-known. You won’t have encountered them in a dynamically typed language, of course, and the most popular statically typed languages Java, C#, or Go don’t support them. The <a href="https://www.typescriptlang.org/docs/handbook/typescript-in-5-minutes-func.html#discriminated-unions">Typescript docs</a> and the <a href="https://flow.org/blog/2015/07/03/Disjoint-Unions/">Flow</a> docs both describe their support for discriminated unions, and exhaustively checking them, but it’s mentioned deep in the annals of the docs, as if it’s some obscure, advanced feature. Myself, I learned about discriminated unions from hipster programming languages, like Purescript, Elm, and Haskell. Other hipster languages have them too – Scala, Rust, F#, and Ocaml, but I haven’t written those very much. They are also called “tagged unions” or “sum types” or “algebraic data types”. These phrases have slightly different meanings, but refer to approximately the same language feature.</p>
<p>In any case, I think you should know how to program this way, so I wrote this post to briefly explain what this technique is, and why you might use it.</p>
<hr />
<h2 id="what-is-discriminated-unions-with-exhaustiveness-checking">What is “discriminated unions with exhaustiveness checking?”</h2>
<p>High-level, <em>exhaustiveness checking</em> is a way for you to ask your type checker “make sure I have explicitly handled all the cases.” And <em>discriminated unions</em> are a way for you to define what the cases are that you want the type checker to enforce that you handle.</p>
<h2 id="exhaustiveness-checking">Exhaustiveness checking</h2>
<p>While some hipster languages do exhaustiveness checking for you by default, in Flow/Typescript, though, you sometimes have to ask the type checker explicitly for an exhaustiveness check, and the way you do that is a little peculiar. You have to implement a function (I call it <code>exhaustive</code>) that has an impossible input type. Then, you call this function from places in your code that should be impossible to reach. The type checker will do a flow analysis. It will succeed if it can confirm the impossible function will never be called - otherwise it will report a type error.</p>
<p>Here’s an example in Flow:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>type <span class="bu">JSON</span> <span class="op">=</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> boolean</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> number</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> string</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="bu">Map</span><span class="op">&lt;</span>string<span class="op">,</span> <span class="bu">JSON</span><span class="op">&gt;;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>type Impossible <span class="op">=</span> <span class="kw">true</span> <span class="op">&amp;</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> exhaustive <span class="op">=</span> (x<span class="op">:</span> Impossible)<span class="op">:</span> any <span class="kw">=&gt;</span> {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'This code should have been unreachable'</span>)<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> prettyPrint <span class="op">=</span> (json<span class="op">:</span> <span class="bu">JSON</span>)<span class="op">:</span> string <span class="kw">=&gt;</span> {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> json <span class="op">===</span> <span class="st">'boolean'</span>) {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (json <span class="op">===</span> <span class="kw">true</span>) {</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'#t'</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'#f'</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> json <span class="op">===</span> <span class="st">'number'</span>) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(json <span class="op">*</span> <span class="dv">1000</span>) <span class="op">/</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> json <span class="op">===</span> <span class="st">'string'</span>) {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (json<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">25</span>) {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'&quot;&lt;blah blah blah&gt;&quot;'</span><span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`&quot;</span><span class="sc">${</span>json<span class="sc">}</span><span class="vs">&quot;`</span><span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">exhaustive</span>(json)<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This code will fail the type checker, because we forgot the <code>Map&lt;string, JSON&gt;</code> case. Flow will report</p>
<blockquote>
<p>Cannot call <code>exhaustive</code> with <code>json</code> bound to <code>x</code> because <code>Map</code> is incompatible with string literal ‘impossible’.</p>
</blockquote>
<p>But if we fix it</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>       return '&quot;&lt;blah blah blah&gt;&quot;';</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>     return `&quot;${json}&quot;`;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">+  if (typeof json === 'object') {</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">+    return '[Object object]'</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="va">+  }</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   return exhaustive(json);</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a> };</span></code></pre></div>
<p>it will pass the type checker.</p>
<h2 id="discriminated-unions">Discriminated Unions</h2>
<p>In the previous example, “all the cases” meant “the different strings <code>typeof</code> can return”. But <code>typeof</code> is not very flexible.</p>
<p>For instance, <code>typeof</code> can’t distinguish between key-value objects and arrays.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">typeof</span> {<span class="dt">foo</span><span class="op">:</span> <span class="st">'bar'</span>}) <span class="co">// 'object'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">typeof</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]) <span class="co">// 'object'</span></span></code></pre></div>
<p>What if we wanted to define our own set of cases, and separate arrays out into their own case?</p>
<p>Recall our <code>JSON</code> type from the previous example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>type <span class="bu">JSON</span> <span class="op">=</span> boolean <span class="op">|</span> number <span class="op">|</span> string <span class="op">|</span> <span class="bu">Map</span><span class="op">&lt;</span>string<span class="op">,</span> <span class="bu">JSON</span><span class="op">&gt;;</span></span></code></pre></div>
<p>The “discriminated union” version of this type would be</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>type TaggedJSON <span class="op">=</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="dt">tag</span><span class="op">:</span> <span class="st">'boolean'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> boolean}</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="dt">tag</span><span class="op">:</span> <span class="st">'number'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> number}</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="dt">tag</span><span class="op">:</span> <span class="st">'string'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> string}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="dt">tag</span><span class="op">:</span> <span class="st">'object'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span>string<span class="op">,</span> TaggedJSON<span class="op">&gt;</span>}</span></code></pre></div>
<p>The <code>tag</code> property here is called the “tag” or “discriminant” or the “sentinel”. The name of the property doesn’t have to be <code>tag</code>, it can be anything. A popular choice is <code>kind</code>. My primary codebase these days uses <code>shape</code>. The important thing is that the tag be present and unique for every branch of the union.</p>
<p>Here is how the analog <code>prettyPrint</code> would look:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> taggedPrettyPrint <span class="op">=</span> (json<span class="op">:</span> TaggedJSON)<span class="op">:</span> string <span class="kw">=&gt;</span> {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (json<span class="op">.</span><span class="at">tag</span> <span class="op">===</span> <span class="st">'boolean'</span>) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (json<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">'true'</span>) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'#t'</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'#f'</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (json<span class="op">.</span><span class="at">tag</span> <span class="op">===</span> <span class="st">'number'</span>) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(json<span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">1000</span>) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toString</span>()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (json<span class="op">.</span><span class="at">tag</span> <span class="op">===</span> <span class="st">'string'</span>) {</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (json<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">25</span>) {</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'&quot;&lt;blah blah blah&gt;&quot;'</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`&quot;</span><span class="sc">${</span>json<span class="op">.</span><span class="at">value</span><span class="sc">}</span><span class="vs">&quot;`</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (json<span class="op">.</span><span class="at">tag</span> <span class="op">===</span> <span class="st">'object'</span>) {</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'[Object object]'</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">exhaustive</span>(json<span class="op">.</span><span class="at">tag</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we can distinguish our array case if we want to</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a> type TaggedJSON = </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>   | {tag: 'boolean', value: boolean}</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>   | {tag: 'number', value: number}</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>   | {tag: 'string', value: string}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>   | {tag: 'object', value: Map&lt;string, TaggedJSON&gt;}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="va">+  | {tag: 'array', value: Array&lt;TaggedJSON&gt;}</span></span></code></pre></div>
<p>Then, Flow will report a type error</p>
<blockquote>
<p>Cannot call <code>exhaustive</code> with <code>json.tag</code> bound to <code>x</code> because string literal <code>array</code> is incompatible with string literal <code>impossible</code></p>
</blockquote>
<p>And then we handle it</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>     return '[Object object]';</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="va">+  if (json.tag === 'array') {</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="va">+    return `[${json.value.map(taggedPrettyPrint).join(', ')}]`;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="va">+  }</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>   return exhaustive(json.tag);</span></code></pre></div>
<p>Discriminated unions are, in a way, the <em>transpose</em> of interfaces. With interfaces - you add a new <em>operation</em> to your interface and you get a type error in all the <em>data types</em> of that interface that haven’t implemented that operation yet. With discriminated unions, you add a new <em>data type</em> to your interface, and you get a type error in all the <em>operations</em> that haven’t added support for that data type yet.</p>
<p>Here’s what <code>prettyPrint</code> would look like if we encoded the problem with interfaces instead of discriminated unions</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>type JSONInterface <span class="op">=</span> <span class="kw">interface</span> {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">prettyPrint</span><span class="op">:</span> () <span class="kw">=&gt;</span> string</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JSONBool <span class="kw">implements</span> JSONInterface {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> boolean</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  prettyPrint <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">true</span>) {</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="st">'#t'</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'#f'</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JSONNumber <span class="kw">implements</span> JSONInterface {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> number</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  prettyPrint <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(<span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">1000</span>) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toString</span>()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JSONString <span class="kw">implements</span> JSONInterface {</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> string</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  prettyPrint <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">25</span>) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">value</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">value</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JSONObject <span class="kw">implements</span> JSONInterface {</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">&gt;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  prettyPrint <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">'[Object object]'</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JSONArray <span class="kw">implements</span> JSONInterface {</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> <span class="bu">Array</span><span class="op">&lt;</span>JSONInterface<span class="op">&gt;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    prettyPrint <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> <span class="vs">`[</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">map</span>(j <span class="kw">=&gt;</span> j<span class="op">.</span><span class="fu">prettyPrint</span>())<span class="op">.</span><span class="fu">join</span>(<span class="st">', '</span>)<span class="sc">}</span><span class="vs">]`</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>(See it in <a href="https://flow.org/try/#0PQKgBAAgZgNg9gdzCYAoVAXAngBwKZgBSAygPIByAkgHYZ4BOUAhgMYEC8YAlrQ822ADeqMKLA56eDNgAK9HhgBcYABQBKMOwB8YAM4Z51AOaoAvuhYwmu3UTLkAQnDgxuAWxww8bvLVskKGjpGVgJhUQA3JhgAVzxlACNnLyZqEXFJaSw5BU1VDW0hdLFuKFUMAAsuXQA6KNiOdk4DOI1wko7MmPpqMAByAGIMPuKxcw6wLp7+gagR0XNzVEtrf3tyGLcEhndPb18MNcDeEIF2+rjlak3t+nSJKVlDDDz1TR12kqnelQBZJkqNXocBi1AAJipKtU6tE4sgwABGAAMKI0wERKKRahqGDgxAMPCM6nSiwsVhsdgo+MMRl2Xh8fkpVBO-DC6Qu8T0BOM90yT1ynDehU+Yi4ZUhVVqHJqXmMlTAOgATABWNqjCbfMAAAwAJIIoVLYXhTFr1WBxp0pN1egaYQ0SWYyasmaQEgArPAsF5cDz0g5HZnBVlFSJG5T-HAAHmphIANEytLzHtlnq8Ch8zZq+gBtV0er1gODuz0YAC683NjuW5IDAEF6PQmFg6ftGQFA3xQiGxBzlPXG1hI+2gp22ImSsB0Q8sjlaGn3t3RJOvlbplrs3rbdK3EwcCo3Qu3TVp-zaOpsW64DwVH14301KZS6aJ+jFkA">Try Flow</a>)</p>
<p>On paper, anything that you can express with a discriminated union, you can express with a group of classes that implement an interface.</p>
<p>In practice, though, in most domains it is more natural to use discriminated unions. Interfaces are best when the <em>operations you are going to perform</em> are the known quantity, and the <em>shapes of the data you will operate upon</em> are the things you are going to discover, or leave open for extension. Discriminated unions work best when the <em>shapes of the data</em> are known, and the operations you will perform are the things you are going to discover and extend as you write the program.</p>
<p>Most programs have known inputs and known outputs, and their job is to transform inputs into outputs. Especially programs like web applications, or compilers.</p>
<p>In any case, I think discriminated unions are <em>particularly</em> useful when you’re manipulating tree-like data structures – like the DOM, JSON or an AST. They’re also good for representing state machines.</p>
<p>I also think they’re also good for representing state machines. Compare</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Not a discriminated union, just a grab-bag of properties that might be set.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>type HTTPResponse <span class="op">=</span> {<span class="op">|</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">status</span><span class="op">:</span> <span class="st">'sent'</span> <span class="op">|</span> <span class="st">'received'</span> <span class="op">|</span> <span class="st">'error'</span> <span class="op">|</span> <span class="st">'done'</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">verb</span><span class="op">:</span> <span class="st">'GET'</span> <span class="op">|</span> <span class="st">'POST'</span><span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  errorMessage<span class="op">?:</span> string<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  headers<span class="op">?:</span> {[string]<span class="op">:</span> string}<span class="op">,</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  statusCode<span class="op">?:</span> number</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>}</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">// A discriminated union that will help prevent users of this data</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">// type from assuming that &quot;headers&quot; or &quot;statusCode&quot; are set, when</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">// in many cases they might not be.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>type TaggedHTTPResponse <span class="op">=</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="op">|</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tag</span><span class="op">:</span> <span class="st">'sent'</span><span class="op">,</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">verb</span><span class="op">:</span> <span class="st">'GET'</span> <span class="op">|</span> <span class="st">'POST'</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span>}</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="op">|</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tag</span><span class="op">:</span> <span class="st">'connectionError'</span><span class="op">,</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">verb</span><span class="op">:</span> <span class="st">'GET'</span> <span class="op">|</span> <span class="st">'POST'</span><span class="op">,</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">errorMessage</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span>}</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="op">|</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tag</span><span class="op">:</span> <span class="st">'received'</span><span class="op">,</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">verb</span><span class="op">:</span> <span class="st">'GET'</span> <span class="op">|</span> <span class="st">'POST'</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> {[string]<span class="op">:</span> string}<span class="op">,</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">statusCode</span><span class="op">:</span> number<span class="op">,</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span>}</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="op">|</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tag</span><span class="op">:</span> <span class="st">'readError'</span><span class="op">,</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">verb</span><span class="op">:</span> <span class="st">'GET'</span> <span class="op">|</span> <span class="st">'POST'</span><span class="op">,</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> {[string]<span class="op">:</span> string}<span class="op">,</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">statusCode</span><span class="op">:</span> number<span class="op">,</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">errorMessage</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span>}</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> {<span class="op">|</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tag</span><span class="op">:</span> <span class="st">'done'</span><span class="op">,</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">url</span><span class="op">:</span> string<span class="op">,</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">verb</span><span class="op">:</span> <span class="st">'POST'</span><span class="op">,</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> {[string]<span class="op">:</span> string}<span class="op">,</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">statusCode</span><span class="op">:</span> number<span class="op">,</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> string</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span>}</span></code></pre></div>
<p>Go forth and use discriminated unions!</p>
    <hr />

    <div class="callToAction">
    <p>
    
      Thanks for reading!
    
    To read more by me, you can subscribe to the <a href="../atom.xml">Atom feed</a> or follow my <a href="https://twitter.com/twitchard">Twitter</a>.</p>
    
    
    <p>You might be interested in my next post, <a href="../posts/2021-11-07-i-hate-ny.html">"i hate ny: a rant by richard"</a>.</p>
    
    
    
    
    
    <p>Check out the previous post, <a href="../posts/2021-04-24-behavior-constraining-features.html">"please, systematically enforce your constraints"</a>.</p>
    
      <blockquote>"Some software features add behaviors, others mainly constrain them."</blockquote>
    
    
    </p>
    
    <h4><a href="../">Home</a></h4>
    </div>
    </section>
</article>

        </main>

        <footer>
          <div class="leftfootleftfootleftfoot">
            Nothing I write represents the opinion of those foolish enough to employ me.
          </div>
          <div class="rightfeetatthemorningfeetatnight">
            Site shamefully generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
          </div>
        </footer>
    </body>
</html>
